generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Email {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isActive  Boolean  @default(true)
  companyId Int

  // Relacionamento com emails recebidos
  receivedEmails ReceivedEmail[]

  @@map("emails")
}

model ReceivedEmail {
  id          Int      @id @default(autoincrement())
  emailId     Int
  fromEmail   String?
  toEmail     String?
  subject     String?
  textContent String?
  htmlContent String?
  attachments Json?    // Armazenar informações dos anexos em JSON
  metadata    Json?    // Outros metadados do email
  createdAt   DateTime @default(now())

  // Relacionamento
  email Email @relation(fields: [emailId], references: [id], onDelete: Cascade)

  @@map("received_emails")
}

model ProcessedEmail {
  id          String   @id @default(cuid())
  messageId   String   @unique // Message-ID do email
  uid         Int      // UID do IMAP
  accountEmail String  // conta que recebeu o email
  fromEmail   String?  // remetente
  toEmail     String?  // destinatário
  subject     String?  // assunto
  receivedAt  DateTime // data que o email foi recebido
  processedAt DateTime @default(now()) // data que foi processado
  
  // Índices compostos para performance
  @@index([accountEmail, receivedAt])
  @@index([messageId])
  @@unique([uid, accountEmail]) // garante que não processe o mesmo UID da mesma conta 2x
}

model ParsedEmailCache {
  id         Int      @id @default(autoincrement())
  messageId  String   @unique
  payload    Json
  createdAt  DateTime @default(now())
}